<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Cancer subtyping using cNMF and literature markers | Rafael Oliveira </title> <meta name="author" content="Rafael Oliveira"> <meta name="description" content="An example of usage of cNMF to identify cancer subtypes"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%A7%AC&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://rafael-silva-oliveira.github.io/blog/2025/distill/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Cancer subtyping using cNMF and literature markers",
            "description": "An example of usage of cNMF to identify cancer subtypes",
            "published": "December 12, 2025",
            "authors": [
              
              {
                "author": "Rafael Oliveira",
                "authorURL": "https://www.linkedin.com/in/rafael-slo/",
                "affiliations": [
                  {
                    "name": "IKOM, NTNU",
                    "url": ""
                  }
                ]
              }
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Rafael</span> Oliveira </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Cancer subtyping using cNMF and literature markers</h1> <p>An example of usage of cNMF to identify cancer subtypes</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#purpose-of-this-tutorial">Purpose of this tutorial</a> </div> <div> <a href="#what-do-we-know-about-sclc">What do we know about SCLC?</a> </div> <div> <a href="#what-is-cnmf">What is cNMF?</a> </div> <div> <a href="#reading-the-data">Reading the data</a> </div> <div> <a href="#running-cnmf">Running cNMF</a> </div> <div> <a href="#plotting-the-results">Plotting the results</a> </div> <div> <a href="#citations">Citations</a> </div> </nav> </d-contents> <h2 id="purpose-of-this-tutorial">Purpose of this tutorial</h2> <p>Cancer is a complex disease that arises from the accumulation of genetic mutations. These mutations are vast, and differ from one patient to another. This makes it so that cancer is generally seen as a heterogeneous disease. This heterogeneity is reflected in the different subtypes of cancer, which are defined by the mutations that are present in the tumor. These subtypes generally have different clinical features, such as the presence of different mutations, the size of the tumor, and the presence of certain genes (key transcription factors). Additionally, these subtypes can be associated with different responses to treatment. Thus, understanding the molecular biology of different cancer types is key to developing effective treatments and, ultimately, improving patient outcomes. Here, I want to show a brief example of how we can use methods such as cNMF to identify cancer subtypes, particularly in Small-cell lung cancer (SCLC).</p> <hr> <h2 id="what-do-we-know-about-sclc">What do we know about SCLC?</h2> <p>While this isn’t intended to be a comprehensive overview of SCLC, it is important to understand what we already know about the disease.</p> <p>SCLC has long been recognized as one of the most aggressive and heterogeneous cancers. For decades, researchers tried to make sense of this complexity by dividing tumors into “classic” and “variant” forms. But as molecular profiling advanced, a more refined classification emerged: one that highlights the role of dominant transcription factors in shaping tumor identity and behavior.</p> <p>Thus, in this tutorial, In this project, we can define molecular subtypes as being biologically consistent groups of tumors characterized by three key features: :</p> <ol> <li>a dominant transcriptional regulator or signaling pathway,</li> <li>a relatively stable molecular signature across different disease stages and experimental models,</li> <li>clear association with distinct biological behaviors or therapeutic responses observed in clinical settings</li> </ol> <p>Today, four major molecular subtypes are recognized:</p> <ul> <li>SCLC-A: Driven by ASCL1, the archetypal neuroendocrine-high form, accounting for about half of all cases.</li> <li>SCLC-N: Defined by NEUROD1, often linked to variant morphology and poorer prognosis.</li> <li>SCLC-P: Characterized by POU2F3, representing non-neuroendocrine tumors with tuft cell features.</li> <li>SCLC-I: The newest player, marked by an inflamed phenotype with immune-related activity.</li> </ul> <h3 id="what-about-sclc-y">What about SCLC-Y?</h3> <p>Before SCLC-I was proposed, some researchers suggested a fourth subtype called SCLC-Y, supposedly driven by YAP1. YAP1 is a transcriptional co-activator involved in proliferation, survival, and drug resistance. Early studies hinted that it might define a distinct group of tumors. However, subsequent work revealed that YAP1 expression was inconsistent and often low, failing to meet the criteria for a stable, subtype-defining regulator. In other words, YAP1 activity was biologically relevant, but it didn’t reliably carve out a separate molecular identity for SCLC tumors.</p> <h3 id="the-inflamed-alternative-sclc-i">The inflamed alternative: SCLC-I</h3> <p>In 2021, Gay et al. (10.1016/j.ccell.2020.12.014) proposed a more convincing fourth subtype: SCLC-I (Inflamed). Unlike the neuroendocrine-driven groups, SCLC-I is distinguished by its immune-active microenvironment. These tumors show signatures of interferon signaling, antigen presentation, and T-cell infiltration—features that set them apart biologically and therapeutically. This inflamed phenotype is particularly exciting because it opens the door to immunotherapy strategies. While classic neuroendocrine SCLC tends to be “immune cold,” SCLC-I tumors may be more responsive to checkpoint inhibitors and other immune-targeted treatments.</p> <p>Note that Gay et al. is performing subtyping (also using cNMF) using a dataset from George et al. (2015) which can be found here: https://www.cbioportal.org/study/summary?id=sclc_ucologne_2015.</p> <p>Here is a summary of what we know about SCLC, from a slide I have created and use to present at conferences:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/subtyping/sclc_info-480.webp 480w,/assets/img/subtyping/sclc_info-800.webp 800w,/assets/img/subtyping/sclc_info-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/subtyping/sclc_info.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <hr> <h2 id="what-is-cnmf">What is cNMF?</h2> <p>cNMF is a non-negative matrix factorization (NMF) method that is particularly useful for identifying cancer subtypes. The “c” in cNMF stands for “consensus” which means that the algorithm will run the analysis multiple times and find the most stable, reliable patterns.</p> <p>cNMF can be used in a variety of settings, including single-cell RNA (scRNA) in order to look for groups of genes that work together, called gene expression programs. This can be extended to bulk RNA, this time looking for cancer subtypes (here we are talking about samples and not single cells).</p> <p>The strength of cNMF is in its ability to solve compositional problems. Imagine sitting in a concert hall, listening to an orchestra. If you focus carefully, you start to notice recurring harmonies from the different instruments. That’s exactly what cNMF does with gene expression data. It picks a part the recurring harmonies of genes, the programs that consistently play together. These GEPs reveal the functional states of cells or the molecular identity of tumors, turning noise into meaningful biological insight.</p> <p>In this tutorial, we will be using the python cNMF package (https://github.com/dylkot/cNMF) which although has been used for scRNA, can also be used for bulk RNA data.</p> <hr> <h2 id="reading-the-data">Reading the data</h2> <p>First, let’s import the necessary libraries. Feel free to get the <code class="language-plaintext highlighter-rouge">requirements.txt</code> file from the github repository and install the packages using <code class="language-plaintext highlighter-rouge">pip install -r requirements.txt</code>.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td> <td class="code"><pre><span class="kn">import</span> <span class="n">os.path</span>
<span class="kn">from</span> <span class="n">lifelines</span> <span class="kn">import</span> <span class="n">CoxPHFitter</span>
<span class="kn">from</span> <span class="n">lifelines.statistics</span> <span class="kn">import</span> <span class="n">logrank_test</span><span class="p">,</span> <span class="n">multivariate_logrank_test</span>
<span class="kn">from</span> <span class="n">lifelines</span> <span class="kn">import</span> <span class="n">KaplanMeierFitter</span>
<span class="kn">import</span> <span class="n">shutil</span>
<span class="kn">from</span> <span class="n">cnmf</span> <span class="kn">import</span> <span class="n">cNMF</span>
<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">from</span> <span class="n">pydeseq2.ds</span> <span class="kn">import</span> <span class="n">DeseqStats</span>
<span class="kn">from</span> <span class="n">pydeseq2.dds</span> <span class="kn">import</span> <span class="n">DeseqDataSet</span>
<span class="kn">from</span> <span class="n">matplotlib.colors</span> <span class="kn">import</span> <span class="n">rgb2hex</span>
<span class="kn">import</span> <span class="n">itertools</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="n">scanpy</span> <span class="k">as</span> <span class="n">sc</span>
<span class="kn">from</span> <span class="n">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span> <span class="n">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="n">decoupler</span> <span class="k">as</span> <span class="n">dc</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">anndata</span> <span class="k">as</span> <span class="n">ad</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="n">pybiomart</span> <span class="kn">import</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">gmean</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">joblib</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="sh">"</span><span class="s">bmh</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">"</span><span class="s">figure.figsize</span><span class="sh">"</span> <span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                     <span class="sh">"</span><span class="s">axes.facecolor</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">white</span><span class="sh">"</span><span class="p">,</span>
                     <span class="sh">"</span><span class="s">axes.edgecolor</span><span class="sh">"</span><span class="p">:</span>  <span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">})</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Now, lets read the count data. In this case, I am already providing the TPM counts, which were converted from FPKM (original data, can be found here https://www.cbioportal.org/study/summary?id=sclc_ucologne_2015). Check the repository link above to find all the data necessary to follow this tutorial.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td> <td class="code"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">_base_dir</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">__file__</span><span class="p">).</span><span class="nf">resolve</span><span class="p">().</span><span class="n">parent</span>
<span class="k">except</span> <span class="nb">NameError</span><span class="p">:</span>
    <span class="n">_base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">cwd</span><span class="p">()</span>

<span class="c1"># The data folder is a subdirectory named 'EGAD00001001244' next to this script.
</span><span class="n">data_file</span> <span class="o">=</span> <span class="n">_base_dir</span> <span class="o">/</span> <span class="sh">"</span><span class="s">EGAD00001001244</span><span class="sh">"</span> <span class="o">/</span> <span class="sh">"</span><span class="s">tpm_counts.csv</span><span class="sh">"</span>

<span class="n">count_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="se">\t</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,)</span>


<span class="n">clinical_metadata_path</span> <span class="o">=</span> <span class="n">_base_dir</span> <span class="o">/</span> \
    <span class="sh">"</span><span class="s">EGAD00001001244</span><span class="sh">"</span> <span class="o">/</span> <span class="sh">"</span><span class="s">data_clinical_patient.txt</span><span class="sh">"</span>

<span class="n">clinical_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">clinical_metadata_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="se">\t</span><span class="sh">"</span><span class="p">)</span>

<span class="n">clinical_metadata</span> <span class="o">=</span> <span class="n">clinical_metadata</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4</span><span class="p">:,</span> <span class="p">:]</span>

<span class="c1"># Subset clinical metadata with the samples from count_data
</span><span class="n">clinical_metadata_subset</span> <span class="o">=</span> <span class="n">clinical_metadata</span><span class="p">[</span>
    <span class="n">clinical_metadata</span><span class="p">[</span><span class="sh">"</span><span class="s">#Patient Identifier</span><span class="sh">"</span><span class="p">].</span><span class="nf">isin</span><span class="p">(</span><span class="n">count_data</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
<span class="p">].</span><span class="nf">copy</span><span class="p">()</span>

<span class="n">clinical_metadata_subset</span><span class="p">.</span><span class="nf">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">"</span><span class="s">#Patient Identifier</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">ID_Sample</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">UICC Tumor Stage</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">tnm_staging</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Sex</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">sex</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Diagnosis Age</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">age_at_sample</span><span class="sh">"</span><span class="p">,</span> 
        <span class="sh">"</span><span class="s">Overall Survival (Months)</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">time_since_t0_death</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Overall Survival Status</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">status_os</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">clinical_metadata_subset</span><span class="p">[</span><span class="sh">"</span><span class="s">status_os</span><span class="sh">"</span><span class="p">].</span><span class="nf">replace</span><span class="p">(</span>
    <span class="p">{</span><span class="sh">"</span><span class="s">1:DECEASED</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">"</span><span class="s">0:LIVING</span><span class="sh">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span>
<span class="p">)</span>

<span class="c1"># Add the staging (&lt; III, LS, IV then ES)
</span><span class="n">clinical_metadata_subset</span><span class="p">[</span><span class="sh">"</span><span class="s">staging</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">clinical_metadata_subset</span><span class="p">[</span><span class="sh">"</span><span class="s">tnm_staging</span><span class="sh">"</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sh">"</span><span class="s">ES</span><span class="sh">"</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="sh">"</span><span class="s">IV</span><span class="sh">"</span> <span class="k">else</span> <span class="sh">"</span><span class="s">LS</span><span class="sh">"</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="sh">"</span><span class="s">nan</span><span class="sh">"</span> <span class="k">else</span> <span class="sh">"</span><span class="s">LS</span><span class="sh">"</span>
<span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">clinical_metadata_subset</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">"</span><span class="s">ID_Sample</span><span class="sh">"</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Error setting index: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="s">Number of samples per stage: </span><span class="si">{</span><span class="n">clinical_metadata_subset</span><span class="p">.</span><span class="n">staging</span><span class="p">.</span><span class="nf">value_counts</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Number of samples per stage: staging LS 72 ES 9 Name: count, dtype: int64</p> <p>We see that we have 72 patients that are in LS (limited stage, &lt;= TNM stage III) and 9 ES (extensive stage, TNM stage IV).</p> <p>And the count_data has this shape:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
</pre></td> <td class="code"><pre><span class="n">count_data</span>
</pre></td> </tr></tbody></table></code></pre></figure> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>B2M</th> <th>FTL</th> <th>HLA-B</th> <th>ANXA1</th> <th>HLA-DRA</th> <th>PFN1</th> <th>CTSD</th> <th>CD74</th> <th>IGLL5</th> <th>LYZ</th> <th>...</th> <th>CYP4F22</th> <th>NDST4</th> <th>CLEC12B</th> <th>IL17C</th> <th>AXDND1</th> <th>SCN2A</th> <th>CNTNAP5</th> <th>RNF133</th> <th>DNAH8</th> <th>YAP1</th> </tr> </thead> <tbody> <tr> <th>sclc_ucologne_2015_S00022</th> <td>2162.154403</td> <td>2298.411925</td> <td>1001.751408</td> <td>23.633396</td> <td>86.991391</td> <td>678.728366</td> <td>472.136116</td> <td>27.912742</td> <td>42.978858</td> <td>28.775967</td> <td>...</td> <td>2.750689</td> <td>8.490031</td> <td>2.725959</td> <td>2.992372</td> <td>2.715768</td> <td>3.514570</td> <td>8.136591</td> <td>2.696780</td> <td>2.728837</td> <td>3.277595</td> </tr> <tr> <th>sclc_ucologne_2015_S00035</th> <td>3160.088999</td> <td>3745.273955</td> <td>648.107862</td> <td>102.795278</td> <td>276.450852</td> <td>615.955668</td> <td>524.715629</td> <td>50.000057</td> <td>46.280251</td> <td>84.170639</td> <td>...</td> <td>2.192853</td> <td>8.469487</td> <td>2.246005</td> <td>3.080709</td> <td>2.148493</td> <td>7.893646</td> <td>2.475983</td> <td>2.318928</td> <td>2.155952</td> <td>3.605534</td> </tr> <tr> <th>sclc_ucologne_2015_S00050</th> <td>2052.014302</td> <td>2118.938263</td> <td>879.408577</td> <td>36.147493</td> <td>423.594166</td> <td>532.336017</td> <td>489.297038</td> <td>109.557077</td> <td>244.091360</td> <td>212.364860</td> <td>...</td> <td>3.146193</td> <td>6.516990</td> <td>2.984626</td> <td>3.215373</td> <td>3.042088</td> <td>4.725947</td> <td>18.991687</td> <td>3.011319</td> <td>3.134531</td> <td>3.915876</td> </tr> <tr> <th>sclc_ucologne_2015_S00213</th> <td>9640.167384</td> <td>14605.657288</td> <td>2289.823486</td> <td>121.938662</td> <td>2079.767782</td> <td>884.827811</td> <td>1074.222337</td> <td>176.478753</td> <td>5425.059394</td> <td>2610.552043</td> <td>...</td> <td>2.681442</td> <td>15.147577</td> <td>2.421056</td> <td>3.124963</td> <td>2.386332</td> <td>4.895384</td> <td>2.558535</td> <td>2.451218</td> <td>2.389190</td> <td>4.352976</td> </tr> <tr> <th>sclc_ucologne_2015_S00356</th> <td>5004.217605</td> <td>4981.908336</td> <td>835.222854</td> <td>119.778900</td> <td>983.900900</td> <td>502.215145</td> <td>514.830956</td> <td>122.104755</td> <td>1418.010653</td> <td>499.754643</td> <td>...</td> <td>2.829266</td> <td>3.128775</td> <td>2.719074</td> <td>3.650863</td> <td>2.776094</td> <td>10.940923</td> <td>4.448620</td> <td>3.396203</td> <td>2.740640</td> <td>5.575360</td> </tr> <tr> <th>...</th> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> </tr> <tr> <th>sclc_ucologne_2015_S02375</th> <td>6812.104434</td> <td>11667.759405</td> <td>1509.701805</td> <td>1282.925898</td> <td>2003.241765</td> <td>1048.792635</td> <td>1064.024598</td> <td>183.230711</td> <td>318.635008</td> <td>572.531677</td> <td>...</td> <td>2.093379</td> <td>2.280902</td> <td>2.106701</td> <td>2.041678</td> <td>2.030944</td> <td>2.036819</td> <td>3.085045</td> <td>1.997111</td> <td>2.072963</td> <td>2.719448</td> </tr> <tr> <th>sclc_ucologne_2015_S02376</th> <td>8251.028221</td> <td>3238.868715</td> <td>3740.925445</td> <td>83.274742</td> <td>501.582874</td> <td>1147.828117</td> <td>389.587217</td> <td>58.089660</td> <td>541.181302</td> <td>293.667019</td> <td>...</td> <td>2.179461</td> <td>6.646879</td> <td>2.105514</td> <td>2.843782</td> <td>2.154875</td> <td>5.445269</td> <td>6.453248</td> <td>2.294543</td> <td>2.117667</td> <td>3.164042</td> </tr> <tr> <th>sclc_ucologne_2015_S02378</th> <td>9520.367291</td> <td>6724.043881</td> <td>2958.637473</td> <td>209.366759</td> <td>1717.925348</td> <td>677.814857</td> <td>1175.556034</td> <td>183.766750</td> <td>267.717238</td> <td>523.855194</td> <td>...</td> <td>2.772599</td> <td>2.877168</td> <td>2.858701</td> <td>3.147568</td> <td>2.824992</td> <td>2.806729</td> <td>3.585936</td> <td>2.965653</td> <td>2.768039</td> <td>6.153518</td> </tr> <tr> <th>sclc_ucologne_2015_S02382</th> <td>3779.392094</td> <td>2525.732381</td> <td>577.241843</td> <td>161.040659</td> <td>226.311589</td> <td>307.053940</td> <td>236.202220</td> <td>49.486211</td> <td>557.569124</td> <td>478.677608</td> <td>...</td> <td>3.289202</td> <td>3.953085</td> <td>3.289202</td> <td>6.149953</td> <td>3.346079</td> <td>4.930345</td> <td>8.773256</td> <td>3.703050</td> <td>3.311947</td> <td>7.840243</td> </tr> <tr> <th>sclc_ucologne_2015_S02397</th> <td>4621.667938</td> <td>5300.872063</td> <td>1401.574063</td> <td>82.634577</td> <td>444.025069</td> <td>779.949035</td> <td>413.593408</td> <td>72.070549</td> <td>338.586292</td> <td>227.066808</td> <td>...</td> <td>2.991421</td> <td>14.824241</td> <td>3.086601</td> <td>4.139198</td> <td>2.982478</td> <td>13.696145</td> <td>4.118115</td> <td>3.192017</td> <td>2.981595</td> <td>4.707087</td> </tr> </tbody> </table> <p>81 rows × 1294 columns</p> </div> <p>Let’s now create an AnnData object and add the log_tpm_counts to it. This will be useful later on for plotting of the main TFs for each group or subtype.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> <td class="code"><pre><span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="p">.</span><span class="nc">AnnData</span><span class="p">(</span><span class="n">count_data</span><span class="p">)</span>

<span class="n">adata</span><span class="p">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">clinical_metadata_subset</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>

<span class="n">adata</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">count_data</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">adata</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="sh">"</span><span class="s">tpm_counts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="p">.</span><span class="n">X</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>

<span class="n">adata</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="sh">"</span><span class="s">log_tpm_counts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log1p</span><span class="p">(</span><span class="n">count_data</span><span class="p">.</span><span class="n">values</span><span class="p">).</span><span class="nf">copy</span><span class="p">()</span>

<span class="n">adata</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="sh">"</span><span class="s">z_log_tpm_counts</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">zscore</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="sh">"</span><span class="s">log_tpm_counts</span><span class="sh">"</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">adata</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>While one could run cNMF using all the genes from the bulk dataset, only a few thousand genes are needed to identify the subtypes. There are several methods to select the most relevant genes, but for this tutorial, I will use the discovery set from the original publication (Gay et al. 2021). These can be found in the supplementary material of the paper (see DOI above).</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> <td class="code"><pre><span class="c1"># Load genes 1300 discovery set
</span><span class="kn">import</span> <span class="n">openpyxl</span>
<span class="n">final_genes</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_excel</span><span class="p">(</span>
    <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">_base_dir</span><span class="si">}</span><span class="s">/EGAD00001001244/1-s2.0-S1535610820306620-mmc2.xlsx</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">final_genes</span> <span class="o">=</span> <span class="n">final_genes</span><span class="p">[</span><span class="sh">"</span><span class="s">Unnamed: 0</span><span class="sh">"</span><span class="p">].</span><span class="nf">tolist</span><span class="p">()</span>
<span class="n">final_genes</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">"</span><span class="s">YAP1</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># adding YAP1 to this list just to test the expression  of YAP1 across the samples to see that it shows a somewhat even expression across identified subtypes. 
</span>
<span class="n">missing_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">gene</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">final_genes</span> <span class="k">if</span> <span class="n">gene</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="p">.</span><span class="n">var_names</span><span class="p">]</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Missing genes:</span><span class="sh">"</span><span class="p">,</span> <span class="n">missing_genes</span><span class="p">)</span>

<span class="n">final_genes_filtered</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">gene</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">final_genes</span> <span class="k">if</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">adata</span><span class="p">.</span><span class="n">var_names</span><span class="p">]</span>
<span class="n">final_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">final_genes_filtered</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">final_adata</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">final_adata</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="sh">"</span><span class="s">tpm_counts</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Lets now crate the TPM counts file that will be used by cNMF.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> <td class="code"><pre><span class="n">counts_file_new</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./temp_counts_subtype_identification.txt</span><span class="sh">"</span>
<span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
	<span class="n">adata</span><span class="p">.</span><span class="n">X</span><span class="p">,</span>
	<span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="p">.</span><span class="n">obs_names</span><span class="p">,</span>
	<span class="n">columns</span><span class="o">=</span><span class="n">adata</span><span class="p">.</span><span class="n">var_names</span><span class="p">,</span>
<span class="p">).</span><span class="nf">to_csv</span><span class="p">(</span><span class="n">counts_file_new</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="se">\t</span><span class="sh">"</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Let’s now run cNMF. Here, we will test a range of components (from 2 to 8). This is generally done if you don’t yet know the optimal number of components/groups/subtypes to use. However, from the literature, we already know for SCLC that the field recognizes this number to be 4, so we will already use this number here.</p> <h2 id="running-cnmf">Running cNMF</h2> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td> <td class="code"><pre><span class="n">subtype_col_name</span><span class="o">=</span><span class="sh">"</span><span class="s">nmf-group-de-novo</span><span class="sh">"</span>
<span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">density_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">components</span><span class="p">:</span> <span class="nb">range</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">mandatory_genes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">ASCL1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NEUROD1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POU2F3</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YAP1</span><span class="sh">"</span><span class="p">]</span> 
<span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">total_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">num_highvar_genes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># number 
</span><span class="n">ntop_genes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">data_save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./</span><span class="sh">"</span>
<span class="n">layer</span> <span class="o">=</span> <span class="sh">"</span><span class="s">tpm_counts</span><span class="sh">"</span>

<span class="n">cnmf_obj_new</span> <span class="o">=</span> <span class="nf">cNMF</span><span class="p">(</span>
	<span class="n">output_dir</span><span class="o">=</span><span class="sh">"</span><span class="s">./cnmf_results_selected_genes</span><span class="sh">"</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">nmf_selected_genes</span><span class="sh">"</span>
<span class="p">)</span>

<span class="n">cnmf_obj_new</span><span class="p">.</span><span class="nf">prepare</span><span class="p">(</span>
	<span class="n">counts_fn</span><span class="o">=</span><span class="n">counts_file_new</span><span class="p">,</span>
	<span class="n">tpm_fn</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">_base_dir</span><span class="si">}</span><span class="s">/temp_counts_subtype_identification.txt</span><span class="sh">"</span><span class="p">,</span> <span class="c1"># note that we can load the TPM counts file directly. Generally, for this package, one can run the raw counts and then it will convert to TPM, but since we don't have access to the raw counts here, we will load the TPM counts directly, which have been calculated from the original FPKM values. 
</span>	<span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span>
	<span class="n">n_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span>
	<span class="n">num_highvar_genes</span><span class="o">=</span><span class="n">num_highvar_genes</span><span class="p">,</span> <span class="c1"># The package may already use this number to use just the top 2000 genes that are highly variable across the samples. 2000 is the default number, but you can change it to something else. In this case, the total number of genes is around 1300, so this number being 2000 won't do much harm.
</span><span class="p">)</span>

<span class="n">cnmf_obj_new</span><span class="p">.</span><span class="nf">factorize</span><span class="p">(</span><span class="n">worker_i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_workers</span><span class="o">=</span><span class="n">total_workers</span><span class="p">)</span>

<span class="n">cnmf_obj_new</span><span class="p">.</span><span class="nf">combine</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>This plot will show the stability and error for each of the K tested (in our case, from 2 to 7 components). We see that the optimal number of components is 4, which offers the best stability and lowest error, which once again confirms the literature.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td> <td class="code"><pre><span class="n">cnmf_obj_new</span><span class="p">.</span><span class="nf">consensus</span><span class="p">(</span>
	<span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
	<span class="n">density_threshold</span><span class="o">=</span><span class="n">density_threshold</span><span class="p">,</span>
	<span class="n">show_clustering</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
	<span class="n">close_clustergram_fig</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">cnmf_obj_new</span><span class="p">.</span><span class="nf">k_selection_plot</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/subtyping/k4-480.webp 480w,/assets/img/subtyping/k4-800.webp 800w,/assets/img/subtyping/k4-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/subtyping/k4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
</pre></td> <td class="code"><pre><span class="n">usage_matrix_nmf_var</span><span class="p">,</span> <span class="n">gep_scores_nmf_var</span><span class="p">,</span> <span class="n">gep_tpm_nmf_var</span><span class="p">,</span> <span class="n">topgenes_nmf_var</span> <span class="o">=</span> <span class="p">(</span>
	<span class="n">cnmf_obj_new</span><span class="p">.</span><span class="nf">load_results</span><span class="p">(</span><span class="n">K</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">density_threshold</span><span class="o">=</span><span class="n">density_threshold</span><span class="p">)</span>
<span class="p">)</span> <span class="c1"># capture the usage matrix, GEP scores, etc.</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Now that we have calculated the usage matrix, we can merge it with the original AnnData object. This is a normalized value, that sums to 1 across our selected K. In this case, we will have 4 new columns, from 1 to 4, representing each of the 4 components. As these are normalized, they can be interpreted as proportions of a given GEP (gene expression program) across each sample. This is particularly useful, as we can do correlations with other biomarkers we may have, or to simply indicate the proportion of subtypes for each sample since, realistically, one patient is likely to have multiple subtypes at once, within a single sample.</p> <p>We can also then take the maximum value of the usage matrix, and give a categorical assignment to each sample based on the maximum value. This is useful for other downstream analysis, such as differential expression analysis, boxplot visualizations, etc.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td> <td class="code"><pre><span class="n">adata_nmf</span> <span class="o">=</span> <span class="n">adata</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">adata_nmf</span><span class="p">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span>
	<span class="n">left</span><span class="o">=</span><span class="n">adata_nmf</span><span class="p">.</span><span class="n">obs</span><span class="p">,</span>
	<span class="n">right</span><span class="o">=</span><span class="n">usage_matrix_nmf_var</span><span class="p">,</span>
	<span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">left</span><span class="sh">"</span><span class="p">,</span>
	<span class="n">left_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
	<span class="n">right_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">top_genes_nmf</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Selecting top </span><span class="si">{</span><span class="n">ntop_genes</span><span class="si">}</span><span class="s"> genes for each subtype</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">gep</span> <span class="ow">in</span> <span class="n">gep_scores_nmf_var</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
	<span class="n">top_genes_nmf</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span>
		<span class="nf">list</span><span class="p">(</span>
			<span class="n">gep_scores_nmf_var</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">gep</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">index</span><span class="p">[</span>
				<span class="p">:</span><span class="n">ntop_genes</span>
			<span class="p">]</span>
		<span class="p">)</span>
	<span class="p">)</span>

<span class="n">top_genes_nmf</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">top_genes_nmf</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">gep_scores_nmf_var</span><span class="p">.</span><span class="n">columns</span><span class="p">).</span><span class="n">T</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">top_genes_nmf</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
	<span class="nf">print</span><span class="p">([</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">top_genes_nmf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">mandatory_genes</span><span class="p">])</span>

<span class="n">adata_nmf</span><span class="p">.</span><span class="n">obs</span><span class="p">[</span><span class="n">subtype_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">usage_matrix_nmf_var</span><span class="p">.</span><span class="nf">idxmax</span><span class="p">(</span>
	<span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span>
	<span class="sa">f</span><span class="sh">"</span><span class="s">Count of groups: </span><span class="si">{</span><span class="n">adata_nmf</span><span class="p">.</span><span class="n">obs</span><span class="p">[</span><span class="n">subtype_col_name</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span>
<span class="p">)</span>

<span class="n">gene_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">"</span><span class="s">gene</span><span class="sh">"</span><span class="p">:</span> <span class="n">adata_nmf</span><span class="p">.</span><span class="n">var_names</span><span class="p">.</span><span class="nf">tolist</span><span class="p">()})</span>

<span class="nf">print</span><span class="p">(</span>
	<span class="sa">f</span><span class="sh">"</span><span class="s">Saving top </span><span class="si">{</span><span class="n">ntop_genes</span><span class="si">}</span><span class="s"> NMF genes to </span><span class="si">{</span><span class="n">data_save_path</span> <span class="o">+</span> <span class="sh">'</span><span class="s">nmf_genes.csv</span><span class="sh">'</span><span class="si">}</span><span class="sh">"</span>
<span class="p">)</span>
<span class="n">gene_df</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="n">data_save_path</span> <span class="o">+</span> <span class="sh">"</span><span class="s">nmf_genes.csv</span><span class="sh">"</span><span class="p">)</span>


<span class="n">adata_nmf</span><span class="p">.</span><span class="n">obs</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Our adata.obs is now looking like:</p> <div> <style scoped="">.dataframe tbody tr th:only-of-type{vertical-align:middle}.dataframe tbody tr th{vertical-align:top}.dataframe thead th{text-align:right}</style> <table border="1" class="dataframe"> <thead> <tr style="text-align: right;"> <th></th> <th>age_at_sample</th> <th>sex</th> <th>Ethnicity Category</th> <th>N Stage</th> <th>M Stage</th> <th>tnm_staging</th> <th>Smoker</th> <th>Smoking History</th> <th>Previous Treatment</th> <th>First Pathologic Diagnosis Biospecimen Acquisition Method Type</th> <th>...</th> <th>Radiation Therapy</th> <th>status_os</th> <th>Progress Free Survival (Months)</th> <th>time_since_t0_death</th> <th>staging</th> <th>1</th> <th>2</th> <th>3</th> <th>4</th> <th>nmf-group-de-novo</th> </tr> <tr> <th>ID_Sample</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> </tr> </thead> <tbody> <tr> <th>sclc_ucologne_2015_S00022</th> <td>47.0</td> <td>Male</td> <td>NaN</td> <td>2</td> <td>0</td> <td>IIIa</td> <td>Current</td> <td>NaN</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>Yes</td> <td>1.0</td> <td>36.0</td> <td>38.0</td> <td>LS</td> <td>0.472208</td> <td>0.506818</td> <td>0.006234</td> <td>0.014740</td> <td>2</td> </tr> <tr> <th>sclc_ucologne_2015_S00035</th> <td>65.0</td> <td>Female</td> <td>NaN</td> <td>1</td> <td>1</td> <td>IV</td> <td>Former</td> <td>NaN</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>No</td> <td>1.0</td> <td>NaN</td> <td>12.0</td> <td>ES</td> <td>0.836763</td> <td>0.000000</td> <td>0.107072</td> <td>0.056165</td> <td>1</td> </tr> <tr> <th>sclc_ucologne_2015_S00050</th> <td>47.0</td> <td>Male</td> <td>NaN</td> <td>0</td> <td>0</td> <td>Ia</td> <td>Current</td> <td>NaN</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>Yes</td> <td>1.0</td> <td>23.0</td> <td>42.0</td> <td>LS</td> <td>0.174228</td> <td>0.798634</td> <td>0.027138</td> <td>0.000000</td> <td>2</td> </tr> <tr> <th>sclc_ucologne_2015_S00213</th> <td>65.0</td> <td>Male</td> <td>NaN</td> <td>2</td> <td>0</td> <td>IIIa</td> <td>NaN</td> <td>NaN</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>NaN</td> <td>1.0</td> <td>NaN</td> <td>13.0</td> <td>LS</td> <td>0.417541</td> <td>0.000000</td> <td>0.539301</td> <td>0.043158</td> <td>3</td> </tr> <tr> <th>sclc_ucologne_2015_S00356</th> <td>54.0</td> <td>Female</td> <td>NaN</td> <td>2</td> <td>0</td> <td>IIIa</td> <td>Current</td> <td>NaN</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>Yes</td> <td>1.0</td> <td>NaN</td> <td>33.0</td> <td>LS</td> <td>0.427171</td> <td>0.283349</td> <td>0.198798</td> <td>0.090682</td> <td>1</td> </tr> <tr> <th>...</th> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> <td>...</td> </tr> <tr> <th>sclc_ucologne_2015_S02375</th> <td>75.0</td> <td>Female</td> <td>NaN</td> <td>0</td> <td>x</td> <td>Ia</td> <td>Current</td> <td>Smoking Pack years:60</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>Yes</td> <td>0.0</td> <td>NaN</td> <td>19.0</td> <td>LS</td> <td>0.034502</td> <td>0.000000</td> <td>0.383714</td> <td>0.581784</td> <td>4</td> </tr> <tr> <th>sclc_ucologne_2015_S02376</th> <td>57.0</td> <td>Female</td> <td>NaN</td> <td>0</td> <td>0</td> <td>Ia</td> <td>Current</td> <td>Smoking Pack years:43</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>No</td> <td>0.0</td> <td>NaN</td> <td>13.0</td> <td>LS</td> <td>0.656241</td> <td>0.029737</td> <td>0.260803</td> <td>0.053218</td> <td>1</td> </tr> <tr> <th>sclc_ucologne_2015_S02378</th> <td>70.0</td> <td>Female</td> <td>NaN</td> <td>0</td> <td>0</td> <td>Ia</td> <td>Current</td> <td>Smoking Pack years:100</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>Yes</td> <td>0.0</td> <td>NaN</td> <td>34.0</td> <td>LS</td> <td>0.175381</td> <td>0.215708</td> <td>0.337704</td> <td>0.271208</td> <td>3</td> </tr> <tr> <th>sclc_ucologne_2015_S02382</th> <td>59.0</td> <td>Male</td> <td>Caucasian</td> <td>3</td> <td>1a</td> <td>IV</td> <td>Current</td> <td>Smoking Pack years:40</td> <td>Relapse</td> <td>Biopsy</td> <td>...</td> <td>Yes</td> <td>1.0</td> <td>5.0</td> <td>16.0</td> <td>ES</td> <td>0.228472</td> <td>0.581772</td> <td>0.024002</td> <td>0.165753</td> <td>2</td> </tr> <tr> <th>sclc_ucologne_2015_S02397</th> <td>48.0</td> <td>Female</td> <td>Asian</td> <td>0</td> <td>0</td> <td>Ia</td> <td>Former</td> <td>Smoking Pack years:0.75</td> <td>Untreated</td> <td>Surgical Resection</td> <td>...</td> <td>No</td> <td>0.0</td> <td>NaN</td> <td>4.0</td> <td>LS</td> <td>0.622328</td> <td>0.080066</td> <td>0.145000</td> <td>0.152606</td> <td>1</td> </tr> </tbody> </table> <p>81 rows × 22 columns</p> </div> <h2 id="plotting-the-results">Plotting the results</h2> <p>Now that we have our subtypes, it is time to plot some of the known markers from SCLC and see which group has highest expression for each of the key markets. To explore this, let’s do some boxplots, showing the groups (i.e. subtypes) against key genes using the log_tpm_counts that we calculated earlier.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td> <td class="code"><pre><span class="c1"># Start by creating a dataframe with the log_tpm_counts and the ID_Samples
</span><span class="n">key_markers_boxplot</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
	<span class="n">adata_nmf</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="sh">"</span><span class="s">log_tpm_counts</span><span class="sh">"</span><span class="p">],</span>
	<span class="n">columns</span><span class="o">=</span><span class="n">adata_nmf</span><span class="p">.</span><span class="n">var_names</span><span class="p">,</span>
	<span class="n">index</span><span class="o">=</span><span class="n">adata_nmf</span><span class="p">.</span><span class="n">obs_names</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Subset just the key genes
</span><span class="n">key_markers_boxplot</span> <span class="o">=</span> <span class="n">key_markers_boxplot</span><span class="p">[[</span><span class="sh">"</span><span class="s">ASCL1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NEUROD1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POU2F3</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YAP1</span><span class="sh">"</span><span class="p">]]</span>

<span class="c1"># Add the NMF grouping we calculated earlier using cNMF
</span><span class="n">merged_data</span> <span class="o">=</span> <span class="n">key_markers_boxplot</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">adata_nmf</span><span class="p">.</span><span class="n">obs</span><span class="p">[[</span><span class="sh">"</span><span class="s">nmf-group-de-novo</span><span class="sh">"</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="sh">"</span><span class="s">ID_Sample</span><span class="sh">"</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">"</span><span class="s">inner</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Now, plot each of the key genes against the NMF groups
</span><span class="k">for</span> <span class="n">key_genes</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">"</span><span class="s">ASCL1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NEUROD1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">YAP1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POU2F3</span><span class="sh">"</span><span class="p">]:</span>
	<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sh">"</span><span class="s">nmf-group-de-novo</span><span class="sh">"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">key_genes</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">merged_data</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="sh">"</span><span class="s">Set2</span><span class="sh">"</span><span class="p">)</span>

	<span class="n">ax</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="sh">"</span><span class="s">NMF groups</span><span class="sh">"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="sh">"</span><span class="s">log TPM counts</span><span class="sh">"</span><span class="p">)</span>
	<span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Boxplot of </span><span class="si">{</span><span class="n">key_genes</span><span class="si">}</span><span class="s"> expression per NMF group</span><span class="sh">"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
	<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">log TPM counts</span><span class="sh">"</span><span class="p">)</span>
	<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">NMF groups</span><span class="sh">"</span><span class="p">)</span>	
	<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
	<span class="n">plt</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>This will give the following boxplots:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/subtyping/ASCL1-480.webp 480w,/assets/img/subtyping/ASCL1-800.webp 800w,/assets/img/subtyping/ASCL1-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/subtyping/ASCL1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/subtyping/NEUROD1-480.webp 480w,/assets/img/subtyping/NEUROD1-800.webp 800w,/assets/img/subtyping/NEUROD1-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/subtyping/NEUROD1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/subtyping/YAP1-480.webp 480w,/assets/img/subtyping/YAP1-800.webp 800w,/assets/img/subtyping/YAP1-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/subtyping/YAP1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/subtyping/pou2f3-480.webp 480w,/assets/img/subtyping/pou2f3-800.webp 800w,/assets/img/subtyping/pou2f3-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/subtyping/pou2f3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>This gives us a good idea of which subtypes are associated with each of the key genes. Now, ideally, if we have the raw counts, the next step is to do some differential expression analysis to see which of the key markers from SCLC (or another cancer being analyzed) are differentially expressed between the subtypes. To do this, one can use the <code class="language-plaintext highlighter-rouge">pydeseq2</code> package, which is a popular tool for differential expression analysis in python. While it is not the focus of this tutorial, I will bring another tutorial later on showing an example of how to use <code class="language-plaintext highlighter-rouge">pydeseq2</code> and a modification to do both <code class="language-plaintext highlighter-rouge">one-vs-one</code> and <code class="language-plaintext highlighter-rouge">one-vs-all</code> comparisons.</p> <p>The next step is to do some more visualizations that will help us understand the subtypes better, this time using gene sets and a radial plot. The gene sets we will use (see code below) are <strong>NE</strong> (neuroendocrine), <strong>nonNE</strong> (non-neuroendocrine), <strong>T-eff</strong> (tumor-effector), <strong>B/PC</strong> (B-cell and plasma cell), and <strong>APM</strong> (antigen processing and presentation) and <strong>Checkpt</strong> (immune checkpoint).</p> <p>Additionally, we will also use a mapping between the numerical NMF groups, and the subtypes based on the boxplots made earlier. We see that cluster 1 has higher expression for ASCL1, so we associate this cluster to A subtype. Cluster 2 has higher expression for NEUROD1, so we associate this cluster to N subtype. Cluster 4 has higher expression for POU2F3, so we associate this cluster to P subtype. The last cluster, cluster 3 can, for now, be associated with the I subtype, even though the expression levels are not as visually different as the other markers.This will be done using a dictionary called <code class="language-plaintext highlighter-rouge">nmf_labels</code> that will map the NMF groups to the subtypes.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
</pre></td> <td class="code"><pre><span class="n">adata_analysis_radial</span> <span class="o">=</span> <span class="n">adata_nmf</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">adata_analysis_radial</span><span class="p">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">adata_analysis_radial</span><span class="p">.</span><span class="n">obs</span><span class="p">[</span>
    <span class="p">[</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">nmf-group-de-novo</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">]</span>

<span class="c1"># Since we already have the log_tpm_counts, we can use them directly, and then only scale them
</span><span class="n">adata_analysis_radial</span><span class="p">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adata_analysis_radial</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="sh">"</span><span class="s">log_tpm_counts</span><span class="sh">"</span><span class="p">].</span><span class="nf">copy</span><span class="p">()</span>
<span class="n">sc</span><span class="p">.</span><span class="n">pp</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="n">adata_analysis_radial</span><span class="p">)</span>

<span class="c1"># These will be the gene sets we will use
</span><span class="n">gene_categories</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">NE</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">CHGA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">DLL3</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">NEUROD1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">INSM1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ASCL1</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">nonNE</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">YAP1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">POU2F3</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MYC</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">REST</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">T-eff</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span>
        <span class="sh">"</span><span class="s">CD8A</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">GZMA</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">GZMB</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">PRF1</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">IFNG</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">CXCL9</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">CXCL10</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">TBX21</span><span class="sh">"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="sh">"</span><span class="s">B/PC</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">CD79A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MS4A1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">MZB1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">JCHAIN</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">APM</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">TAP1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TAP2</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">B2M</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">HLA-A</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">HLA-C</span><span class="sh">"</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">Checkpt</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">PDCD1</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CD274</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">LAG3</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">CTLA4</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">BTLA</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">TIGIT</span><span class="sh">"</span><span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Compute scores for each category
</span><span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">genes</span> <span class="ow">in</span> <span class="n">gene_categories</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="n">sc</span><span class="p">.</span><span class="n">tl</span><span class="p">.</span><span class="nf">score_genes</span><span class="p">(</span><span class="n">adata_analysis_radial</span><span class="p">,</span> <span class="n">genes</span><span class="p">,</span>
                      <span class="n">score_name</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s">_score</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Calculate mean scores for each NMF group
</span><span class="n">nmf_scores</span> <span class="o">=</span> <span class="n">adata_analysis_radial</span><span class="p">.</span><span class="n">obs</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="sh">"</span><span class="s">nmf-group-de-novo</span><span class="sh">"</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>

<span class="c1"># Normalize scores (Z-score across subsets)
</span><span class="n">score_columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s">_score</span><span class="sh">"</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">gene_categories</span><span class="p">.</span><span class="nf">keys</span><span class="p">()]</span>
<span class="n">nmf_scores_norm</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">nmf_scores</span><span class="p">[</span><span class="n">score_columns</span><span class="p">]</span> <span class="o">-</span> <span class="n">nmf_scores</span><span class="p">[</span><span class="n">score_columns</span><span class="p">].</span><span class="nf">mean</span><span class="p">()</span>
<span class="p">)</span> <span class="o">/</span> <span class="n">nmf_scores</span><span class="p">[</span><span class="n">score_columns</span><span class="p">].</span><span class="nf">std</span><span class="p">()</span>

<span class="c1"># Define NMF labels
</span><span class="n">nmf_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">2</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">N</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">3</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">I</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">4</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Colors for each NMF group
</span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">#8A7EB5</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">#67C28E</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">#E75480</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">#FFA500</span><span class="sh">"</span><span class="p">]</span>
<span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">#4169E1</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># A - RoyalBlue (cold)
</span>    <span class="sh">"</span><span class="s">2</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">#008080</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># N - Teal (cold)
</span>    <span class="sh">"</span><span class="s">3</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">#DC143C</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># I-nNE - Crimson (warm)
</span>    <span class="sh">"</span><span class="s">4</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">#FF8C00</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># I-NE - DarkOrange (warm)
</span><span class="p">}</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="sh">"</span><span class="s">polar</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Prepare angles
</span><span class="n">categories</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">gene_categories</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span>
<span class="n">N</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
<span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="o">/</span> <span class="nf">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
<span class="n">angles</span> <span class="o">+=</span> <span class="n">angles</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Complete the loop
</span>
<span class="c1"># Plot each group
</span><span class="k">for</span> <span class="n">nmf_group</span> <span class="ow">in</span> <span class="nf">sorted</span><span class="p">(</span><span class="n">nmf_scores_norm</span><span class="p">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">nmf_scores_norm</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nmf_group</span><span class="p">,</span> <span class="n">score_columns</span><span class="p">].</span><span class="nf">to_frame</span><span class="p">().</span><span class="n">T</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="nf">flatten</span><span class="p">().</span><span class="nf">tolist</span><span class="p">()</span>
    <span class="n">values</span> <span class="o">+=</span> <span class="n">values</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Complete the loop
</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">nmf_labels</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">nmf_group</span><span class="p">,</span> <span class="n">nmf_group</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">color_map</span><span class="p">[</span><span class="n">nmf_group</span><span class="p">]</span>

    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span>
        <span class="n">angles</span><span class="p">,</span>
        <span class="n">values</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="sh">"</span><span class="s">solid</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="s">NMF</span><span class="si">{</span><span class="n">nmf_group</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">fill</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># Format the plot
</span><span class="n">ax</span><span class="p">.</span><span class="nf">set_theta_offset</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticks</span><span class="p">(</span><span class="n">angles</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xticklabels</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_yticklabels</span><span class="p">([])</span>  <span class="c1"># Hide radial labels
</span><span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">grey</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">spines</span><span class="p">[</span><span class="sh">"</span><span class="s">polar</span><span class="sh">"</span><span class="p">].</span><span class="nf">set_visible</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

<span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">"</span><span class="s">upper right</span><span class="sh">"</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Radial plot of NMF groups</span><span class="sh">"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>


<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/subtyping/radial-480.webp 480w,/assets/img/subtyping/radial-800.webp 800w,/assets/img/subtyping/radial-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/img/subtyping/radial.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <hr> <p>And there you have it! We have now identified the molecular subtypes of SCLC using cNMF, with matching distributions from the original publication.</p> <p>There is a lot we can do with this information. Cell type devoncolution on the bulk RNA data to further evaluate cell type composition, survival analysis, differential expression analysis, functional enrichment analysis, etc. I plan on bringing more tutorials across all things related to transcriptomics, so stay tuned!</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> <d-article> <br> <br> </d-article> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Rafael Oliveira. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/overrides.js"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>